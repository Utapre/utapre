<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>うたプレ 管理画面</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

  <style>
    :root{
      --bg:#f6f6f9;
      --card:#fff;
      --text:#222;
      --sub:#666;
      --line:#e7e7ee;
      --accent:#ff6fb5;
      --accent2:#ffc36f;
      --ok:#24a148;
      --ng:#e11d48;
      --radius:18px;
      --shadow:0 10px 26px rgba(0,0,0,.08);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, sans-serif;
      color:var(--text);
      background: radial-gradient(circle at top, #ffeef7 0, var(--bg) 45%, var(--bg) 100%);
      min-height:100vh;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:18px 14px 40px}
    header{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      margin-bottom:14px;
    }
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:34px;height:34px;border-radius:14px;
      background:conic-gradient(from 180deg, #ff6fb5, #ffc36f, #6fb7ff, #ff6fb5);
      box-shadow:0 10px 22px rgba(0,0,0,.18);
      display:flex;align-items:center;justify-content:center;
      color:#fff;font-weight:900;
    }
    .title{font-weight:800}
    .sub{color:var(--sub);font-size:12px}
    .pill{
      font-size:11px;color:var(--sub);
      border:1px solid var(--line);
      background:rgba(255,255,255,.8);
      padding:6px 10px;border-radius:999px;
      user-select:text;
    }

    .grid{display:grid;grid-template-columns: 0.95fr 1.05fr;gap:14px}
    @media (max-width:980px){ .grid{grid-template-columns:1fr} }

    .card{
      background:var(--card);
      border:1px solid rgba(255,255,255,.9);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px 14px;
    }
    .card h2{
      margin:0 0 10px 0;
      font-size:15px;
    }
    .info{color:var(--sub);font-size:12px;line-height:1.55}
    .muted{color:var(--sub)}
    .alert{
      padding:10px 12px;border-radius:14px;
      border:1px solid #ffd6e7;
      background:#fff5fa;
      font-size:12px; line-height:1.55;
      margin-bottom:14px;
      display:none;
    }

    .btn{
      border:none; cursor:pointer;
      border-radius:999px;
      padding:9px 14px;
      font-size:12px; font-weight:800;
      display:inline-flex; align-items:center; gap:8px;
    }
    .btn.primary{
      color:#fff;
      background:linear-gradient(90deg,var(--accent),var(--accent2));
      box-shadow:0 8px 18px rgba(0,0,0,.16);
    }
    .btn.ghost{
      color:var(--sub);
      background:rgba(255,255,255,.9);
      border:1px solid var(--line);
    }
    .btn.danger{
      color:#fff;
      background:linear-gradient(90deg,#ff3b81,#ff6f6f);
      box-shadow:0 8px 18px rgba(0,0,0,.14);
    }
    .btn:disabled{opacity:.6;cursor:not-allowed}

    input[type="text"], textarea, select{
      width:100%;
      border:1px solid var(--line);
      border-radius:12px;
      padding:9px 10px;
      font-size:13px;
      outline:none;
      background:rgba(255,255,255,.95);
    }
    textarea{min-height:78px;resize:vertical}
    input:focus, textarea:focus, select:focus{
      border-color:var(--accent);
      box-shadow:0 0 0 1px rgba(255,111,181,.22);
    }

    /* ticket list */
    .searchRow{display:flex; gap:10px; align-items:center; margin-bottom:10px}
    .list{
      border:1px solid var(--line);
      border-radius:14px;
      overflow:auto;
      max-height:520px;
      background:#fafafe;
    }
    .item{
      padding:10px 12px;
      border-bottom:1px dashed var(--line);
      cursor:pointer;
      display:flex;
      gap:10px;
      justify-content:space-between;
      align-items:flex-start;
    }
    .item:last-child{border-bottom:none}
    .item:hover{background:#fff}
    .item.active{background:#fff0f7}
    .item .left{display:flex; flex-direction:column; gap:3px}
    .item .serial{font-weight:900; font-size:12px}
    .item .name{font-size:12px; color:var(--sub)}
    .item .right{font-size:11px; color:var(--sub); white-space:nowrap}

    /* ticket detail */
    .kv{display:grid;grid-template-columns: 140px 1fr;gap:8px; font-size:13px; padding:6px 0;border-bottom:1px dashed var(--line)}
    .kv:last-child{border-bottom:none}
    .k{color:var(--sub)}
    .v{font-weight:700}

    /* hearing */
    pre{
      margin:0;
      padding:10px;
      border:1px solid var(--line);
      border-radius:14px;
      background:#fafafe;
      overflow:auto;
      max-height:260px;
      font-size:12px;
      color:#333;
    }

    /* chat */
    .chatbox{
      height:330px;
      overflow:auto;
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px;
      background:#fafafe;
    }
    .msg{display:flex;margin:8px 0;gap:8px}
    .msg.me{justify-content:flex-end}
    .bubble{
      max-width:82%;
      padding:9px 10px;
      border-radius:14px;
      border:1px solid #ececf5;
      background:#fff;
      font-size:13px;
      line-height:1.5;
      word-break:break-word;
    }
    .msg.me .bubble{
      background:#fff7fb;
      border-color:#ffd6e7;
    }
    .meta{font-size:11px;color:var(--sub);margin-top:4px}
    .filelink{
      display:inline-block;
      margin-top:6px;
      font-size:12px;
      color:#0b63ce;
      text-decoration:underline;
      word-break:break-all;
    }
    .chatinput{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      margin-top:10px;
      align-items:end;
    }
    .chatinput textarea{min-height:52px}

    /* notice */
    .noticeGrid{display:grid; gap:10px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .statusline{font-size:12px;color:var(--sub);min-height:18px}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">U</div>
        <div>
          <div class="title">うたプレ 管理画面</div>
          <div class="sub">チケット選択 → ヒアリング確認 / お知らせ / チャット返信</div>
        </div>
      </div>
      <div class="pill" id="adminHint">管理URLは非公開運用</div>
    </header>

    <div id="topAlert" class="alert"></div>

    <div class="grid">
      <!-- LEFT: ticket list -->
      <div class="card">
        <h2>チケット一覧</h2>

        <div class="searchRow">
          <input type="text" id="searchBox" placeholder="検索：シリアル / 名前 / プラン" />
          <button class="btn ghost" id="reloadBtn">更新</button>
        </div>

        <div class="list" id="ticketList"></div>
        <div class="info" style="margin-top:10px;">
          ※ URLを知ってる人だけが開ける前提。運営用リンクは絶対に外に出さない。
        </div>
      </div>

      <!-- RIGHT: detail + hearing + notice + chat -->
      <div style="display:grid; gap:14px;">
        <div class="card" id="detailCard" style="display:none;">
          <h2>チケット詳細</h2>
          <div id="ticketDetail"></div>

          <div class="row" style="margin-top:10px;">
            <div style="flex:1; min-width:220px;">
              <div class="muted" style="font-size:12px; font-weight:800; margin-bottom:6px;">進行ステータス</div>
              <select id="statusSelect">
                <option value="0">0：ヒアリング入力待ち</option>
                <option value="1">1：ヒアリング送信済み（確認中）</option>
                <option value="2">2：制作準備中</option>
                <option value="3">3：制作中</option>
                <option value="4">4：確認・修正対応中</option>
                <option value="5">5：納品準備中</option>
                <option value="6">6：納品済み</option>
              </select>
            </div>
            <button class="btn primary" id="saveStatusBtn">ステータス更新</button>
            <span class="statusline" id="statusSaveMsg"></span>
          </div>
        </div>

        <div class="card" id="hearingCard" style="display:none;">
          <h2>ヒアリング内容（送信済み）</h2>
          <div class="info" style="margin-bottom:10px;">送信後ロックされる前提。ここは確認専用。</div>
          <pre id="hearingPre">(未送信)</pre>
        </div>

        <div class="card" id="noticeCard" style="display:none;">
          <h2>お知らせ（マイページ表示）</h2>
          <div class="info" style="margin-bottom:10px;">
            全体 or このチケットだけに表示できる。重要度も付けられる。
          </div>

          <div class="noticeGrid">
            <div class="row">
              <div style="flex:1; min-width:220px;">
                <div class="muted" style="font-size:12px; font-weight:800; margin-bottom:6px;">対象</div>
                <select id="noticeTarget">
                  <option value="all">全体お知らせ</option>
                  <option value="ticket">このチケットだけ</option>
                </select>
              </div>
              <div style="width:180px;">
                <div class="muted" style="font-size:12px; font-weight:800; margin-bottom:6px;">重要度</div>
                <select id="noticeSeverity">
                  <option value="0">通常</option>
                  <option value="1">重要</option>
                  <option value="2">緊急</option>
                </select>
              </div>
            </div>

            <div>
              <div class="muted" style="font-size:12px; font-weight:800; margin-bottom:6px;">タイトル</div>
              <input type="text" id="noticeTitle" placeholder="例：制作進行について" />
            </div>

            <div>
              <div class="muted" style="font-size:12px; font-weight:800; margin-bottom:6px;">本文</div>
              <textarea id="noticeBody" placeholder="お知らせ内容"></textarea>
            </div>

            <div class="row">
              <button class="btn primary" id="saveNoticeBtn">保存</button>
              <button class="btn danger" id="disableTicketNoticeBtn">このチケットのお知らせを非表示</button>
              <span class="statusline" id="noticeMsg"></span>
            </div>

            <div class="info">
              ※「非表示」は<strong>このチケット向け</strong>のみ一括でOFFにする（全体お知らせは消えない）。
            </div>
          </div>
        </div>

        <div class="card" id="chatCard" style="display:none;">
          <h2>チャット（管理用）</h2>
          <div class="info" style="margin-bottom:10px;">
            お客さんとの制作やりとりをここで返信。添付ファイルは今はユーザー側から送ってもらう運用。
          </div>

          <div class="chatbox" id="chatBox"></div>

          <div class="chatinput">
            <textarea id="chatText" placeholder="返信を書いて送信"></textarea>
            <button class="btn primary" id="sendBtn">送信</button>
          </div>
          <div class="statusline" id="chatMsg"></div>
        </div>

        <div class="card" id="emptyCard">
          <h2>使い方</h2>
          <div class="info">
            左の一覧からチケットを選ぶ → 右にヒアリング/お知らせ/チャットが出る。<br>
            管理URLは外に出さない（ブックマーク運用）。
          </div>
        </div>

      </div>
    </div>
  </div>

  <script>
    // =====================
    // Supabase
    // =====================
    const SUPABASE_URL = "https://nnexyynjimfpdcqeuxgn.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5uZXh5eW5qaW1mcGRjcWV1eGduIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDAxMzAsImV4cCI6MjA4MTAxNjEzMH0.ZWAsrtzHAf0A9wDAfXPUKTlwQ92G1KhgUWFAyLULl9c";

    const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // =====================
    // State
    // =====================
    let tickets = [];
    let currentTicket = null;

    // =====================
    // Helpers
    // =====================
    function showAlert(msg){
      const el = document.getElementById("topAlert");
      el.textContent = msg;
      el.style.display = "block";
      setTimeout(()=>{ el.style.display = "none"; }, 4000);
    }

    function escapeHtml(str){
      return (str ?? "").toString()
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function formatTime(iso){
      try{
        return new Date(iso).toLocaleString("ja-JP",{hour12:false});
      }catch{ return ""; }
    }

    function statusText(step){
      const map = {
        0: "ヒアリング入力待ち",
        1: "ヒアリング送信済み（確認中）",
        2: "制作準備中",
        3: "制作中",
        4: "確認・修正対応中",
        5: "納品準備中",
        6: "納品済み"
      };
      return map[step] ?? `進行：${step}`;
    }

    // =====================
    // Load tickets
    // =====================
    async function loadTickets(){
      const { data, error } = await supa
        .from("tickets")
        .select("*")
        .order("created_at", { ascending: false });

      if (error) throw error;
      tickets = data || [];
      renderTicketList();
    }

    function renderTicketList(){
      const q = (document.getElementById("searchBox").value || "").trim().toLowerCase();
      const list = document.getElementById("ticketList");
      list.innerHTML = "";

      const filtered = tickets.filter(t=>{
        const hay = `${t.serial||""} ${t.user_name||""} ${t.plan_name||""}`.toLowerCase();
        return !q || hay.includes(q);
      });

      filtered.forEach(t=>{
        const div = document.createElement("div");
        div.className = "item" + (currentTicket?.id === t.id ? " active" : "");
        div.innerHTML = `
          <div class="left">
            <div class="serial">${escapeHtml(t.serial || "-")}</div>
            <div class="name">${escapeHtml(t.user_name || "（未入力）")} / ${escapeHtml(t.plan_name || "（プラン未設定）")}</div>
          </div>
          <div class="right">${escapeHtml(statusText(t.status_step ?? 0))}</div>
        `;
        div.onclick = ()=>selectTicket(t);
        list.appendChild(div);
      });

      if (filtered.length === 0){
        const empty = document.createElement("div");
        empty.className = "item";
        empty.style.cursor = "default";
        empty.innerHTML = `<div class="muted">該当なし</div>`;
        list.appendChild(empty);
      }
    }

    // =====================
    // Ticket select
    // =====================
    async function selectTicket(t){
      currentTicket = t;
      renderTicketList();

      document.getElementById("emptyCard").style.display = "none";
      document.getElementById("detailCard").style.display = "block";
      document.getElementById("hearingCard").style.display = "block";
      document.getElementById("noticeCard").style.display = "block";
      document.getElementById("chatCard").style.display = "block";

      // detail
      const detail = document.getElementById("ticketDetail");
      detail.innerHTML = `
        <div class="kv"><div class="k">シリアル</div><div class="v">${escapeHtml(t.serial||"-")}</div></div>
        <div class="kv"><div class="k">お名前</div><div class="v">${escapeHtml(t.user_name||"-")}</div></div>
        <div class="kv"><div class="k">プレゼント</div><div class="v">${escapeHtml(t.gift_from||"（なし）")}</div></div>
        <div class="kv"><div class="k">プラン</div><div class="v">${escapeHtml(t.plan_name||"-")}</div></div>
        <div class="kv"><div class="k">納期目安</div><div class="v">${escapeHtml(t.plan_lead_time||"（未設定）")}</div></div>
        <div class="kv"><div class="k">内容</div><div class="v">${escapeHtml(t.plan_description||"（未設定）")}</div></div>
      `;

      // status select
      document.getElementById("statusSelect").value = String(t.status_step ?? 0);
      document.getElementById("statusSaveMsg").textContent = "";

      // load hearing / chat
      await loadHearing(t.id);
      await loadChat(t.id);
    }

    async function loadHearing(ticketId){
      const pre = document.getElementById("hearingPre");
      pre.textContent = "(読み込み中…)";

      const { data, error } = await supa
        .from("ticket_hearings")
        .select("*")
        .eq("ticket_id", ticketId)
        .maybeSingle();

      if (error){
        pre.textContent = "(取得失敗)";
        console.error(error);
        return;
      }

      if (!data){
        pre.textContent = "(未送信)";
        return;
      }

      pre.textContent = JSON.stringify(data.hearing_data, null, 2);
    }

    // =====================
    // Status update
    // =====================
    document.getElementById("saveStatusBtn").onclick = async ()=>{
      if (!currentTicket) return;
      const btn = document.getElementById("saveStatusBtn");
      const msg = document.getElementById("statusSaveMsg");
      const newStep = Number(document.getElementById("statusSelect").value);

      btn.disabled = true;
      msg.textContent = "更新中…";

      try{
        const { error } = await supa
          .from("tickets")
          .update({ status_step: newStep })
          .eq("id", currentTicket.id);

        if (error) throw error;

        // state update
        currentTicket.status_step = newStep;
        msg.textContent = "更新した";
        setTimeout(()=>msg.textContent="", 2000);
        renderTicketList();
      }catch(e){
        console.error(e);
        msg.textContent = "失敗：" + (e?.message || e);
      }finally{
        btn.disabled = false;
      }
    };

    // =====================
    // Notice
    // =====================
    document.getElementById("saveNoticeBtn").onclick = async ()=>{
      if (!currentTicket) return;

      const btn = document.getElementById("saveNoticeBtn");
      const msg = document.getElementById("noticeMsg");
      const target = document.getElementById("noticeTarget").value;
      const sev = Number(document.getElementById("noticeSeverity").value);
      const title = document.getElementById("noticeTitle").value || "";
      const body = document.getElementById("noticeBody").value || "";

      if (!body.trim()){
        msg.textContent = "本文は必須";
        return;
      }

      btn.disabled = true;
      msg.textContent = "保存中…";

      try{
        const payload = {
          ticket_id: target === "ticket" ? currentTicket.id : null,
          title,
          body,
          severity: sev,
          is_active: true
        };

        const { error } = await supa.from("ticket_notices").insert(payload);
        if (error) throw error;

        msg.textContent = "保存した（マイページに反映される）";
        setTimeout(()=>msg.textContent="", 2500);

        // clear inputs a bit
        document.getElementById("noticeTitle").value = "";
        document.getElementById("noticeBody").value = "";
      }catch(e){
        console.error(e);
        msg.textContent = "失敗：" + (e?.message || e);
      }finally{
        btn.disabled = false;
      }
    };

    document.getElementById("disableTicketNoticeBtn").onclick = async ()=>{
      if (!currentTicket) return;

      const btn = document.getElementById("disableTicketNoticeBtn");
      const msg = document.getElementById("noticeMsg");

      btn.disabled = true;
      msg.textContent = "非表示中…";

      try{
        const { error } = await supa
          .from("ticket_notices")
          .update({ is_active:false })
          .eq("ticket_id", currentTicket.id);

        if (error) throw error;

        msg.textContent = "このチケット向けお知らせを非表示にした";
        setTimeout(()=>msg.textContent="", 2500);
      }catch(e){
        console.error(e);
        msg.textContent = "失敗：" + (e?.message || e);
      }finally{
        btn.disabled = false;
      }
    };

    // =====================
    // Chat
    // =====================
    function renderChat(list){
      const box = document.getElementById("chatBox");
      box.innerHTML = "";

      list.forEach(m=>{
        const isMe = (m.sender === "admin");
        const wrap = document.createElement("div");
        wrap.className = "msg" + (isMe ? " me" : "");

        const bubble = document.createElement("div");
        bubble.className = "bubble";

        const body = document.createElement("div");
        body.innerHTML = escapeHtml(m.message || "").replaceAll("\n","<br>");
        bubble.appendChild(body);

        if (m.file_url){
          const a = document.createElement("a");
          a.className = "filelink";
          a.href = m.file_url;
          a.target = "_blank";
          a.rel = "noreferrer";
          a.textContent = "添付ファイルを開く";
          bubble.appendChild(a);
        }

        const meta = document.createElement("div");
        meta.className = "meta";
        meta.textContent = `${m.sender ?? ""} ・ ${formatTime(m.created_at)}`;
        bubble.appendChild(meta);

        wrap.appendChild(bubble);
        box.appendChild(wrap);
      });

      box.scrollTop = box.scrollHeight;
    }

    async function loadChat(ticketId){
      const { data, error } = await supa
        .from("ticket_messages")
        .select("*")
        .eq("ticket_id", ticketId)
        .order("created_at", { ascending: true });

      if (error){
        console.error(error);
        return;
      }
      renderChat(data || []);
    }

    document.getElementById("sendBtn").onclick = async ()=>{
      if (!currentTicket) return;

      const btn = document.getElementById("sendBtn");
      const msg = document.getElementById("chatMsg");
      const ta = document.getElementById("chatText");
      const text = ta.value.trim();
      if (!text) return;

      btn.disabled = true;
      msg.textContent = "送信中…";

      try{
        const { error } = await supa.from("ticket_messages").insert({
          ticket_id: currentTicket.id,
          sender: "admin",
          message: text
        });
        if (error) throw error;

        ta.value = "";
        msg.textContent = "送信した";
        setTimeout(()=>msg.textContent="", 2000);
        await loadChat(currentTicket.id);
      }catch(e){
        console.error(e);
        msg.textContent = "失敗：" + (e?.message || e);
      }finally{
        btn.disabled = false;
      }
    };

    // =====================
    // Boot
    // =====================
    document.getElementById("reloadBtn").onclick = async ()=>{
      try{
        await loadTickets();
        showAlert("一覧を更新した");
      }catch(e){
        console.error(e);
        showAlert("更新失敗：" + (e?.message || e));
      }
    };

    document.getElementById("searchBox").addEventListener("input", renderTicketList);

    (async ()=>{
      try{
        await loadTickets();
      }catch(e){
        console.error(e);
        showAlert("読み込みに失敗：" + (e?.message || e));
      }
    })();
  </script>
</body>
</html>
