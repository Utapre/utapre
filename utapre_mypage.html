<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>うたプレ マイページ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- supabase-js v2 UMD -->
  <script src="https://unpkg.com/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

  <style>
    :root {
      --bg: #f5f5f7;
      --card-bg: #ffffff;
      --accent: #ff6fb5;
      --accent-soft: #ffe3f1;
      --accent-deep: #ff3f98;
      --text-main: #222222;
      --text-sub: #666666;
      --border-soft: #e0e0e5;
      --radius-xl: 24px;
      --shadow-soft: 0 12px 30px rgba(0,0,0,0.06);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: radial-gradient(circle at top, #ffeef7 0, #f5f5f7 45%, #f5f5f7 100%);
      color: var(--text-main);
      min-height: 100vh;
    }

    .app {
      max-width: 1040px;
      margin: 0 auto;
      padding: 24px 16px 40px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .brand-logo {
      width: 36px;
      height: 36px;
      border-radius: 12px;
      background: conic-gradient(from 180deg, #ff6fb5, #ffc36f, #6fb7ff, #ff6fb5);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #fff;
      font-weight: 800;
      font-size: 18px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.16);
    }

    .brand-title { font-size: 20px; font-weight: 700; }
    .brand-sub { font-size: 12px; color: var(--text-sub); }

    .header-right { text-align: right; font-size: 12px; color: var(--text-sub); }

    main {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-soft);
      padding: 18px 20px;
      border: 1px solid rgba(255,255,255,0.8);
    }

    .status-card {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1.1fr);
      gap: 16px;
      align-items: stretch;
    }

    .status-main h1 {
      font-size: 18px;
      margin-bottom: 4px;
    }

    .status-main p {
      font-size: 13px;
      color: var(--text-sub);
      line-height: 1.6;
    }

    .ticket-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 5px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.8);
      border: 1px solid var(--border-soft);
      font-size: 11px;
      margin-top: 8px;
    }

    .ticket-id {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 11px;
      letter-spacing: 0.08em;
    }

    .status-chip {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: var(--accent-soft);
      color: var(--accent);
      font-size: 11px;
      font-weight: 600;
      margin-top: 8px;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent);
      box-shadow: 0 0 0 4px rgba(255,111,181,0.2);
    }

    .status-steps {
      font-size: 11px;
      color: var(--text-sub);
      margin-top: 10px;
    }

    .status-steps span.current {
      color: var(--accent);
      font-weight: 600;
    }

    .progress-wrapper { margin-top: 12px; }

    .progress-label {
      display: flex;
      justify-content: space-between;
      font-size: 11px;
      color: var(--text-sub);
      margin-bottom: 4px;
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      border-radius: 999px;
      background: #e9e9f0;
      overflow: hidden;
    }

    .progress-bar-inner {
      height: 100%;
      width: 0%;
      background: linear-gradient(90deg, #ff6fb5, #ffc36f);
      border-radius: 999px;
      transition: width 0.5s ease-out;
    }

    .status-sub {
      font-size: 11px;
      color: var(--text-sub);
      margin-top: 10px;
    }

    .plan-info {
      font-size: 12px;
      line-height: 1.7;
    }

    .plan-pill {
      display: inline-flex;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.9);
      border: 1px solid var(--border-soft);
      font-size: 11px;
      margin-bottom: 6px;
    }

    .two-column {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1.1fr);
      gap: 18px;
    }

    .card-title { font-size: 14px; font-weight: 600; margin-bottom: 8px; }
    .card-sub { font-size: 12px; color: var(--text-sub); margin-bottom: 12px; }

    .field { margin-bottom: 10px; }

    .field label {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      font-size: 12px;
      margin-bottom: 4px;
    }
    .field label span { font-weight: 500; }
    .field label small { font-size: 10px; color: var(--text-sub); }

    input[type="text"],
    input[type="email"],
    textarea,
    select {
      width: 100%;
      padding: 8px 9px;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      font-size: 12px;
      outline: none;
      background: rgba(255,255,255,0.9);
    }

    textarea {
      resize: vertical;
      min-height: 70px;
    }

    input:focus,
    textarea:focus,
    select:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 1px rgba(255,111,181,0.2);
    }

    .help-text {
      font-size: 11px;
      color: var(--text-sub);
      margin-top: 4px;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin-top: 4px;
    }

    .btn-primary {
      background: linear-gradient(90deg, #ff6fb5, #ffc36f);
      color: #fff;
      box-shadow: 0 8px 18px rgba(0,0,0,0.18);
    }

    .btn-ghost {
      background: rgba(255,255,255,0.9);
      border: 1px solid var(--border-soft);
      color: var(--text-sub);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 10px;
      background: #f3f3ff;
      color: var(--text-sub);
      margin-right: 6px;
    }

    .badge-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: #b0b3ff;
    }

    .notice-list {
      list-style: none;
      margin-top: 10px;
      font-size: 12px;
      color: var(--text-sub);
    }

    .notice-list li + li {
      margin-top: 6px;
      padding-top: 6px;
      border-top: 1px dashed #ececf5;
    }

    .notice-date {
      font-size: 10px;
      color: #999;
      margin-right: 6px;
    }

    /* チャット部分 */

    .chat-card {
      margin-top: 4px;
    }

    .chat-messages {
      max-height: 260px;
      overflow-y: auto;
      padding-right: 4px;
      margin-bottom: 10px;
    }

    .chat-empty {
      font-size: 12px;
      color: var(--text-sub);
      padding: 8px 4px;
    }

    .chat-row {
      display: flex;
      margin-bottom: 6px;
    }

    .chat-row.client {
      justify-content: flex-end;
    }

    .chat-row.admin {
      justify-content: flex-start;
    }

    .chat-bubble {
      max-width: 80%;
      padding: 8px 10px;
      border-radius: 14px;
      font-size: 12px;
      line-height: 1.5;
      box-shadow: 0 4px 10px rgba(0,0,0,0.03);
    }

    .chat-bubble.client {
      background: var(--accent-soft);
      color: var(--text-main);
      border-bottom-right-radius: 4px;
    }

    .chat-bubble.admin {
      background: #f1f1f8;
      color: var(--text-main);
      border-bottom-left-radius: 4px;
    }

    .chat-meta {
      font-size: 10px;
      color: var(--text-sub);
      margin-top: 4px;
      display: flex;
      justify-content: space-between;
      gap: 6px;
    }

    .chat-file {
      margin-top: 4px;
      font-size: 11px;
    }

    .chat-file a {
      color: var(--accent-deep);
      text-decoration: none;
    }

    .chat-file a:hover {
      text-decoration: underline;
    }

    .chat-from-label {
      font-weight: 600;
    }

    .chat-input-row {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 4px;
    }

    .chat-input-row textarea {
      min-height: 60px;
    }

    .chat-bottom-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .chat-file-input {
      font-size: 11px;
    }

    .chat-status {
      font-size: 11px;
      color: var(--text-sub);
      margin-top: 2px;
    }

    footer {
      margin-top: 14px;
      font-size: 11px;
      color: var(--text-sub);
      text-align: center;
    }

    @media (max-width: 768px) {
      .status-card,
      .two-column {
        grid-template-columns: minmax(0, 1fr);
      }

      .card { padding: 14px 14px; }

      header {
        flex-direction: column;
        align-items: flex-start;
        gap: 6px;
      }

      .header-right { text-align: left; }

      .chat-bubble {
        max-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <header>
      <div class="brand">
        <div class="brand-logo">U</div>
        <div>
          <div class="brand-title">うたプレ マイページ</div>
          <div class="brand-sub">推しのための、プレゼント音楽制作チケット</div>
        </div>
      </div>
      <div class="header-right">
        <div id="userNameLabel">ようこそ</div>
        <div id="miniStatusLabel">チケット照合が完了しました</div>
      </div>
    </header>

    <main>
      <!-- ステータス ＋ チケット情報 -->
      <section class="card status-card">
        <div class="status-main">
          <h1 id="welcomeTitle">〇〇さんの制作マイページ</h1>
          <p>
            こちらは、チケットを使っての作品制作を進めるための専用ページです。<br/>
            下のステップに沿って情報をご入力いただくと、制作がスムーズにスタートします。
          </p>

          <div class="ticket-badge">
            <span>チケットID</span>
            <span class="ticket-id" id="ticketIdLabel">UTP-XXXX-XXXX</span>
          </div>

          <div class="status-chip">
            <span class="status-dot"></span>
            <span id="statusLabel">ヒアリング入力待ち</span>
          </div>

          <div class="status-steps">
            <span class="current">① ヒアリング入力</span> → 
            <span>② 制作中</span> → 
            <span>③ 仕上がり確認</span> → 
            <span>④ 納品完了</span>
          </div>

          <div class="progress-wrapper">
            <div class="progress-label">
              <span>進行状況</span>
              <span id="progressPercentLabel">0%</span>
            </div>
            <div class="progress-bar">
              <div class="progress-bar-inner" id="progressBarInner"></div>
            </div>
          </div>

          <div class="status-sub" id="statusDetail">
            まずは下の「ヒアリングフォーム」から、曲やイメージについて教えてください。
          </div>
        </div>

        <div class="plan-info">
          <div class="plan-pill" id="planNamePill">プラン：歌ってみたMIX</div>
          <div>
            <strong>チケット内容</strong><br>
            <span id="planDescription">
              歌ってみた音源のMIX（ピッチ補正・タイミング調整込み）を1曲分制作します。<br>
              通常納期は<span id="planLeadTime">10〜14日程度</span>です。
            </span>
          </div>
          <div style="margin-top:10px;">
            <strong>このチケットをプレゼントしてくれた方</strong><br>
            <span id="giftFrom">（情報が登録されていません）</span>
          </div>
        </div>
      </section>

      <!-- ヒアリング & お知らせ -->
      <section class="two-column">
        <section class="card">
          <div class="card-title">ヒアリングフォーム（イメージメモ）</div>
          <div class="card-sub">
            制作を進めるために、曲やイメージについてメモしておけるフォームです。<br>
            このデモではブラウザ内にだけ保存され、運営には送信されません。
          </div>

          <form id="hearingForm">
            <div class="field">
              <label>
                <span>お名前（呼び名）</span>
                <small>作品ページに掲載される可能性があります</small>
              </label>
              <input type="text" id="fieldDisplayName" placeholder="例）おもちまる" />
            </div>

            <div class="field">
              <label><span>楽曲タイトル / 使用する音源</span></label>
              <input type="text" id="fieldSongTitle" placeholder="例）〇〇 / △△のカバー" />
            </div>

            <div class="field">
              <label>
                <span>完成イメージ・こだわり</span>
                <small>雰囲気・重視してほしいポイントなど</small>
              </label>
              <textarea id="fieldImage" placeholder="例）アイドル系で明るく、歌詞がはっきり聞こえるMIXにしてほしい など"></textarea>
            </div>

            <button type="button" class="btn btn-primary" id="saveHearingButton">
              この内容を端末に一時保存
            </button>
            <div class="help-text" id="hearingSaveStatus"></div>
          </form>
        </section>

        <section class="card">
          <div class="card-title">運営からのお知らせ（サンプル）</div>
          <div class="card-sub">
            制作の進行に関する連絡や、追加でお願いしたいことがある場合、ここに表示されます。
          </div>

          <div>
            <span class="badge">
              <span class="badge-dot"></span> 最新ステータス
            </span>
            <span class="badge">
              <span class="badge-dot" style="background:#ffb0cf;"></span> 納期目安
            </span>
          </div>

          <ul class="notice-list" id="noticeList"></ul>
        </section>
      </section>

      <!-- チャット（やりとり） -->
      <section class="card chat-card">
        <div class="card-title">制作に関するやりとり</div>
        <div class="card-sub">
          うたプレ運営（制作者）とのやりとりを残しておけるチャットです。<br>
          追加のご要望や、修正してほしいポイントがあればこちらからお送りください。
        </div>

        <div id="chatMessages" class="chat-messages">
          <div class="chat-empty">メッセージはまだありません。</div>
        </div>

        <form id="chatForm">
          <div class="chat-input-row">
            <textarea
              id="chatBody"
              placeholder="例）サビのコーラスを少し大きめにしてほしいです　など"
            ></textarea>

            <div class="chat-bottom-row">
              <div class="chat-file-input">
                <label style="font-size:11px;">
                  音源ファイルや資料を添付（任意）：
                  <input type="file" id="chatFile" />
                </label>
              </div>

              <button type="submit" class="btn btn-primary" id="chatSendButton">
                メッセージを送信
              </button>
            </div>
            <div class="chat-status" id="chatStatus">
              ※ 送信内容は、うたプレ運営とのやりとりの記録として保存されます。
            </div>
          </div>
        </form>
      </section>
    </main>

    <footer>
      © <span id="thisYear"></span> utapre / おもちまる. All rights reserved.
    </footer>
  </div>

  <script>
    // ▼ あなたの Supabase プロジェクト情報 ▼
    const SUPABASE_URL = "https://nnexyynjimfpdcqeuxgn.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5uZXh5eW5qaW1mcGRjcWV1eGduIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NDAxMzAsImV4cCI6MjA4MTAxNjEzMH0.ZWAsrtzHAf0A9wDAfXPUKTlwQ92G1KhgUWFAyLULl9c";

    const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentTicketId = null;  // tickets.id
    let currentUserName = "ゲスト";

    function getTokenFromQuery() {
      const params = new URLSearchParams(window.location.search);
      return params.get("token");
    }

    function getStatusInfo(step) {
      switch (step) {
        case 0:
          return {
            label: "ヒアリング入力待ち",
            detail:
              "まずはヒアリングフォームのご入力をお願いいたします。ご入力が確認でき次第、制作がスタートします。",
            percent: 10,
          };
        case 1:
          return {
            label: "制作中",
            detail:
              "いただいた内容をもとに、現在制作を進めています。進捗があり次第こちらにお知らせします。",
            percent: 50,
          };
        case 2:
          return {
            label: "仕上がり確認待ち",
            detail:
              "仮完成データをご確認いただいている段階です。修正のご希望があれば遠慮なくお知らせください。",
            percent: 80,
          };
        case 3:
          return {
            label: "納品完了",
            detail: "作品の納品が完了しました。ご利用ありがとうございました！",
            percent: 100,
          };
        default:
          return {
            label: "準備中",
            detail: "ステータス情報の取得を準備しています。",
            percent: 0,
          };
      }
    }

    async function fetchMyPageData(token) {
      const { data, error } = await supa
        .from("tickets")
        .select("*")
        .eq("access_token", token)
        .limit(1);

      if (error) {
        console.error(error);
        throw new Error("マイページ情報の取得に失敗しました。");
      }
      if (!data || !data.length) {
        throw new Error("対応するチケットが見つかりませんでした。");
      }
      return data[0];
    }

    // ヒアリング保存用（ブラウザ内だけ）
    function getStorageKey(ticketSerial) {
      return "utapre_hearing_" + ticketSerial;
    }
    function loadHearing(ticketSerial) {
      const raw = localStorage.getItem(getStorageKey(ticketSerial));
      if (!raw) return null;
      try { return JSON.parse(raw); } catch { return null; }
    }
    function saveHearing(ticketSerial, payload) {
      localStorage.setItem(getStorageKey(ticketSerial), JSON.stringify(payload));
    }

    function formatDateTime(ts) {
      if (!ts) return "";
      const d = new Date(ts);
      if (Number.isNaN(d.getTime())) return "";
      return d.toLocaleString("ja-JP");
    }

    /* ------------ チャット関連 ------------ */

    async function loadChatMessages() {
      if (!currentTicketId) return;
      const listEl = document.getElementById("chatMessages");
      listEl.innerHTML = '<div class="chat-empty">読み込み中です…</div>';

      const { data, error } = await supa
        .from("ticket_messages")
        .select("*")
        .eq("ticket_id", currentTicketId)
        .order("created_at", { ascending: true });

      if (error) {
        console.error("loadChatMessages error:", error);
        listEl.innerHTML =
          '<div class="chat-empty">メッセージの取得に失敗しました。</div>';
        return;
      }

      if (!data || data.length === 0) {
        listEl.innerHTML =
          '<div class="chat-empty">メッセージはまだありません。</div>';
        return;
      }

      listEl.innerHTML = "";

      data.forEach((msg) => {
        const row = document.createElement("div");
        row.className = "chat-row " + (msg.from_role === "client" ? "client" : "admin");

        const bubble = document.createElement("div");
        bubble.className =
          "chat-bubble " + (msg.from_role === "client" ? "client" : "admin");

        const body = document.createElement("div");
        body.textContent = msg.body || "(本文なし)";
        bubble.appendChild(body);

        if (msg.file_url) {
          const fileDiv = document.createElement("div");
          fileDiv.className = "chat-file";
          const a = document.createElement("a");
          a.href = msg.file_url;
          a.target = "_blank";
          a.rel = "noopener noreferrer";

          // 拡張子からざっくり種別を判定してラベルを付ける
          let label = "添付ファイルを開く";
          if (msg.file_url.match(/\.(png|jpe?g|gif|webp)$/i)) {
            label = "画像ファイルを開く";
          } else if (msg.file_url.match(/\.(mp3|wav|ogg|m4a)$/i)) {
            label = "音声ファイルを開く";
          } else if (msg.file_url.match(/\.(mp4|mov|webm)$/i)) {
            label = "動画ファイルを開く";
          }

          a.textContent = label;
          fileDiv.appendChild(a);
          bubble.appendChild(fileDiv);
        }

        const meta = document.createElement("div");
        meta.className = "chat-meta";

        const fromLabel = document.createElement("span");
        fromLabel.className = "chat-from-label";
        fromLabel.textContent = msg.from_role === "client" ? "あなた" : "うたプレ運営";

        const timeLabel = document.createElement("span");
        timeLabel.textContent = formatDateTime(msg.created_at);

        meta.appendChild(fromLabel);
        meta.appendChild(timeLabel);

        bubble.appendChild(meta);
        row.appendChild(bubble);
        listEl.appendChild(row);
      });

      // 一番下までスクロール
      listEl.scrollTop = listEl.scrollHeight;
    }

    async function sendChatMessage(event) {
      event.preventDefault();
      if (!currentTicketId) return;

      const bodyEl = document.getElementById("chatBody");
      const fileEl = document.getElementById("chatFile");
      const statusEl = document.getElementById("chatStatus");
      const sendBtn = document.getElementById("chatSendButton");

      const body = bodyEl.value.trim();
      const file = fileEl.files[0] || null;

      if (!body && !file) {
        statusEl.textContent = "メッセージかファイルのどちらかを入力してください。";
        return;
      }

      statusEl.textContent = "送信中です…";
      sendBtn.disabled = true;

      let fileUrl = null;
      let fileName = null; // 画面には出さない運用なので基本 null のまま

      try {
        if (file) {
          // 拡張子だけ取り出す（例: ".png"）
          const originalName = file.name;
          const extMatch = originalName.match(/\.([^.]+)$/);
          const ext = extMatch ? "." + extMatch[1] : "";

          // Supabase用には「英数字ベースの安全なファイル名」を使う（日本語等は使わない）
          const safeBase = "file_" + Date.now();
          const path = `${currentTicketId}/${safeBase}${ext}`;

          const { data: uploaded, error: uploadError } = await supa.storage
            .from("ticket-chat-files")
            .upload(path, file, { upsert: true });

          if (uploadError) {
            console.error("upload error:", uploadError);
            statusEl.textContent =
              "ファイルのアップロードに失敗しました：" + uploadError.message;
            sendBtn.disabled = false;
            return;
          }

          const { data: publicData } = supa.storage
            .from("ticket-chat-files")
            .getPublicUrl(path);

          fileUrl = publicData.publicUrl;
          // fileName はここでは null のまま運用（元の名前を表に出さない）
        }

        const { error: insertError } = await supa.from("ticket_messages").insert({
          ticket_id: currentTicketId,
          from_role: "client",
          body: body || null,
          file_url: fileUrl,
          file_name: fileName,
        });

        if (insertError) {
          console.error("insert message error:", insertError);
          statusEl.textContent = "メッセージの送信に失敗しました。";
          sendBtn.disabled = false;
          return;
        }

        // フォームをクリア
        bodyEl.value = "";
        fileEl.value = "";
        statusEl.textContent = "送信しました。";

        // メッセージ再読み込み
        await loadChatMessages();
      } catch (e) {
        console.error("sendChatMessage error:", e);
        statusEl.textContent = "エラーが発生しました。時間をおいてお試しください。";
      } finally {
        sendBtn.disabled = false;
      }
    }

    async function initMyPage() {
      document.getElementById("thisYear").textContent =
        new Date().getFullYear();

      const token = getTokenFromQuery();
      if (!token) {
        alert("URLに token が含まれていません。例：?token=testtoken123");
        return;
      }

      try {
        const t = await fetchMyPageData(token);
        const ticketSerial = t.serial;
        currentTicketId = t.id;
        currentUserName = t.user_name || "ゲスト";

        // ヘッダー
        document.getElementById("userNameLabel").textContent =
          currentUserName + " さん、こんにちは";
        document.getElementById("welcomeTitle").textContent =
          currentUserName + " さんの制作マイページ";
        document.getElementById("ticketIdLabel").textContent = ticketSerial;

        // プラン情報
        document.getElementById("planNamePill").textContent =
          "プラン：" + (t.plan_name || "未設定");
        document.getElementById("planLeadTime").textContent =
          t.plan_lead_time || "未設定";
        document.getElementById("giftFrom").textContent =
          t.gift_from || "（登録されていません）";

        const planDesc =
          t.plan_description ||
          "このチケットの詳細説明は現在登録されていません。";
        document.getElementById("planDescription").innerHTML =
          planDesc +
          "<br>通常納期は<span id='planLeadTimeInner'>" +
          (t.plan_lead_time || "未設定") +
          "</span>です。";

        // ステータス
        const statusInfo = getStatusInfo(t.status_step ?? 0);
        document.getElementById("statusLabel").textContent = statusInfo.label;
        document.getElementById("statusDetail").textContent =
          statusInfo.detail;
        document.getElementById("progressPercentLabel").textContent =
          statusInfo.percent + "%";
        document.getElementById("progressBarInner").style.width =
          statusInfo.percent + "%";

        // お知らせ（サンプル）
        const noticeListEl = document.getElementById("noticeList");
        noticeListEl.innerHTML = "";
        const today = new Date().toISOString().slice(0, 10);
        const notices = [
          {
            date: today,
            title: "ようこそ！ヒアリングのご入力をお願いします。",
            body: "楽曲タイトルと完成イメージをご入力いただけますと、制作がスムーズになります。",
          },
          {
            date: today,
            title: "納期目安について",
            body:
              "現在の納期目安は「" +
              (t.plan_lead_time || "未設定") +
              "」です。混雑状況により前後する可能性があります。",
          },
        ];
        notices.forEach((n) => {
          const li = document.createElement("li");
          li.innerHTML =
            '<span class="notice-date">' +
            n.date +
            "</span><strong>" +
            n.title +
            "</strong> " +
            n.body;
          noticeListEl.appendChild(li);
        });

        // ヒアリング（ローカル保存）
        const saveStatus = document.getElementById("hearingSaveStatus");
        const displayNameEl = document.getElementById("fieldDisplayName");
        const songTitleEl = document.getElementById("fieldSongTitle");
        const imageEl = document.getElementById("fieldImage");

        const saved = loadHearing(ticketSerial);
        if (saved) {
          displayNameEl.value = saved.displayName || "";
          songTitleEl.value = saved.songTitle || "";
          imageEl.value = saved.image || "";
          saveStatus.textContent =
            "※ 前回入力した内容を読み込みました（この端末のみ）。";
        }

        document
          .getElementById("saveHearingButton")
          .addEventListener("click", () => {
            const payload = {
              displayName: displayNameEl.value,
              songTitle: songTitleEl.value,
              image: imageEl.value,
              ticketSerial,
            };
            saveHearing(ticketSerial, payload);
            saveStatus.textContent =
              "※ この端末のブラウザ内に一時保存しました（運営にはまだ送信されていません）。";
          });

        // チャット初期化
        document
          .getElementById("chatForm")
          .addEventListener("submit", sendChatMessage);

        await loadChatMessages();

        // 簡易ポーリング：15秒ごとに更新（任意）
        setInterval(loadChatMessages, 15000);
      } catch (e) {
        console.error(e);
        alert(e.message);
      }
    }

    document.addEventListener("DOMContentLoaded", initMyPage);
  </script>
</body>
</html>
