<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>うたプレ マイページ</title>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --bg:#f6f7fb;
      --card:#fff;
      --text:#111827;
      --muted:#6b7280;
      --border:#e5e7eb;
      --shadow:0 10px 30px rgba(0,0,0,.06);
      --radius:16px;
      --accent:#111827;
      --good:#22c55e;
      --warn:#f59e0b;
      --bad:#ef4444;
    }

    body{
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family: system-ui, -apple-system, "Hiragino Sans", "Noto Sans JP", sans-serif;
      font-size:16px;
      line-height:1.65;
    }

    .wrap{
      max-width:980px;
      margin:0 auto;
      padding:18px 14px 48px;
    }

    .topbar{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      flex-wrap:wrap;
    }

    .title{ font-size:18px; font-weight:900; margin:0; }
    .sub{ font-size:13px; color:var(--muted); margin-top:4px; }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 12px;
      border-radius:999px;
      border:1px solid var(--border);
      background:#fff;
      font-weight:900;
    }
    .dot{ width:10px; height:10px; border-radius:50%; background:var(--good); }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      margin:14px 0;
    }

    h2{
      font-size:14px;
      color:var(--muted);
      margin:0 0 10px;
    }

    .muted{ font-size:13px; color:var(--muted); }

    /* notices */
    .notice{
      border:1px solid var(--border);
      border-left:6px solid #d1d5db;
      border-radius:14px;
      padding:12px;
      margin:10px 0;
      background:#fff;
    }
    .notice.s1{ border-left-color:var(--warn); }
    .notice.s2{ border-left-color:var(--bad); }
    .noticeTitle{ font-weight:900; margin-bottom:4px; }

    /* chat */
    .chatBox{
      height:420px;
      overflow:auto;
      border:1px solid var(--border);
      border-radius:14px;
      padding:12px;
      background:#fafafa;
    }
    .chatRow{ display:flex; margin:8px 0; }
    .chatRow.user{ justify-content:flex-end; }
    .bubble{
      max-width:78%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:#fff;
      white-space:pre-wrap;
    }
    .chatRow.user .bubble{
      background:var(--accent);
      color:#fff;
      border-color:var(--accent);
    }
    .meta{ font-size:12px; color:var(--muted); margin-top:6px; }

    textarea,input{
      width:100%;
      border:1px solid var(--border);
      border-radius:12px;
      padding:10px;
      font-size:16px;
      box-sizing:border-box;
    }

    .btn{
      border:1px solid var(--border);
      background:var(--accent);
      color:#fff;
      border-radius:12px;
      padding:10px 14px;
      font-weight:900;
      cursor:pointer;
    }
  </style>
</head>

<body>
<div class="wrap">

  <div class="topbar">
    <div>
      <p class="title">うたプレ マイページ</p>
      <p class="sub">制作状況・お知らせ・チャット</p>
    </div>
    <div class="pill">
      <span class="dot"></span>
      <span id="statusText">読み込み中…</span>
    </div>
  </div>

  <div class="card">
    <h2>お知らせ</h2>
    <div id="noticeList" class="muted">読み込み中…</div>
  </div>

  <div class="card">
    <h2>進行状況</h2>
    <div id="progressArea" class="muted">読み込み中…</div>
  </div>

  <div class="card">
    <h2>チャット</h2>
    <div id="chatMessages" class="chatBox"></div>

    <textarea id="chatInput" placeholder="メッセージを書く"></textarea>
    <div style="height:8px"></div>
    <button id="sendBtn" class="btn">送信</button>

    <div id="chatState" class="muted" style="margin-top:6px"></div>
  </div>

</div>

<script>
  // ★ 反映済み Supabase 情報
  const SUPABASE_URL = "https://nnexyynjimfpdcqeuxgn.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_6bOa3KOYxSKY7jindPuLmQ_snmU9_YC";

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const qs = new URLSearchParams(location.search);
  const token = qs.get("token");

  const el = id => document.getElementById(id);

  function esc(s){
    return (s ?? "").replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
  }

  let ticketId = null;

  async function loadTicket(){
    const { data } = await supabase
      .from("tickets")
      .select("id,status_step")
      .eq("access_token", token)
      .single();

    ticketId = data.id;
    el("statusText").textContent = "ステータス：" + data.status_step;
    el("progressArea").textContent = "現在の工程：" + data.status_step;
  }

  async function loadNotices(){
    const { data } = await supabase
      .from("ticket_notices")
      .select("*")
      .eq("is_active", true)
      .or(`ticket_id.is.null,ticket_id.eq.${ticketId}`)
      .order("created_at", { ascending:false });

    if (!data.length){
      el("noticeList").textContent = "現在お知らせはありません。";
      return;
    }

    el("noticeList").innerHTML = data.map(n => `
      <div class="notice s${n.severity}">
        <div class="noticeTitle">${esc(n.title)}</div>
        <div>${esc(n.body)}</div>
      </div>
    `).join("");
  }

  async function loadMessages(){
    const { data } = await supabase
      .from("ticket_messages")
      .select("*")
      .eq("ticket_id", ticketId)
      .order("created_at");

    el("chatMessages").innerHTML = data.map(m => {
      const role = m.sender ?? m.from_role;
      return `
        <div class="chatRow ${role === "user" ? "user":""}">
          <div class="bubble">
            ${esc(m.message)}
            <div class="meta">${role}</div>
          </div>
        </div>
      `;
    }).join("");

    el("chatMessages").scrollTop = el("chatMessages").scrollHeight;
  }

  async function sendMessage(){
    const text = el("chatInput").value.trim();
    if (!text) return;

    await supabase.from("ticket_messages").insert([{
      ticket_id: ticketId,
      sender: "user",
      from_role: "user",
      message: text
    }]);

    el("chatInput").value = "";
    loadMessages();
  }

  el("sendBtn").onclick = sendMessage;

  (async ()=>{
    await loadTicket();
    await loadNotices();
    await loadMessages();
  })();
</script>
</body>
</html>
